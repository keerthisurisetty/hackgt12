<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Financial Resilience Platform - Cyber Recovery Made Simple</title>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="clinic-styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="nav-brand">
                <h1>üè• Clinic Financial Resilience Platform</h1>
                <p class="tagline" id="clinic-tagline">Stop waiting for insurance payouts. Take control of your cyber recovery.</p>
            </div>
            <div class="header-actions">
                <div class="clinic-info" id="clinic-info" style="display: none;">
                    <span class="clinic-name" id="clinic-name"></span>
                    <span class="clinic-type" id="clinic-type"></span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot success"></div>
                    <span id="ai-status">Recovery Assistant Online</span>
                </div>
                <button class="btn-logout" id="logout-btn" onclick="logout()" style="display: none;">Logout</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            
            <!-- Financial Overview Section -->
            <section class="card financial-overview">
                <h2>Financial Impact Assessment</h2>
                <p class="section-description">See exactly how a cyberattack would affect YOUR clinic's survival timeline</p>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="switchTab('financial', 'before')">üìä Current State</button>
                        <button class="tab-btn" onclick="switchTab('financial', 'after')">üí• After Cyberattack</button>
                    </div>
                    
                    <div class="tab-content">
                        <div id="financial-before" class="tab-pane active">
                            <h3>Typical Finances</h3>
                            <p class="tab-subtitle">What your finances would look like had you not been hit with the cyberattack (aka: end goal of recovery)</p>
                            
                            <div class="metrics-grid" id="before-metrics">
                                <!-- Before metrics will be populated here -->
                            </div>
                        </div>
                        
                        <div id="financial-after" class="tab-pane">
                            <h3>Post-Cyberattack Impact</h3>
                            <p class="tab-subtitle">Financial damage and recovery projections after a cyberattack</p>
                            
                            <div class="metrics-grid" id="after-metrics">
                                <!-- After metrics will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Clinic Setup & Recovery Tools Section -->
            <section class="card recovery-tools">
                <h2>Recovery Analysis & Tools</h2>
                <p class="section-description">Input your clinic details and get personalized recovery strategies</p>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="switchTab('tools', 'before')">Setup</button>
                        <button class="tab-btn" onclick="switchTab('tools', 'after')">Recovery Plan</button>
                    </div>
                    
                    <div class="tab-content">
                        <div id="tools-before" class="tab-pane active">
                            <h3>Clinic Profile & Attack Details</h3>
                            <p class="tab-subtitle">Configure your cyberattack scenario and recovery parameters</p>
                            
                            <div class="input-section">
                                <div class="clinic-selection" id="clinic-selection" style="display: none;">
                                    <h4>Select Your Clinic Type</h4>
                                    <div class="clinic-options">
                                        <div class="clinic-card" data-clinic="small" onclick="selectClinic('small')">
                                            <h5>Solo Family Practice</h5>
                                            <p>1 doctor, family medicine focus</p>
                                            <div class="clinic-stats">
                                                <div class="stat">
                                                    <span class="stat-label">Annual Revenue</span>
                                                    <span class="stat-value">$320K</span>
                                                </div>
                                                <div class="stat">
                                                    <span class="stat-label">Operating Days Left</span>
                                                    <span class="stat-value critical">48 days</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="clinic-card" data-clinic="medium" onclick="selectClinic('medium')">
                                            <h5>Metro Medical Group</h5>
                                            <p>2-3 doctors, multi-specialty</p>
                                            <div class="clinic-stats">
                                                <div class="stat">
                                                    <span class="stat-label">Annual Revenue</span>
                                                    <span class="stat-value">$780K</span>
                                                </div>
                                                <div class="stat">
                                                    <span class="stat-label">Operating Days Left</span>
                                                    <span class="stat-value warning">55 days</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="authenticated-clinic-info" id="authenticated-clinic-info">
                                    <h4>Your Clinic Profile</h4>
                                    <div class="clinic-profile-card">
                                        <div class="profile-header">
                                            <h5 id="profile-clinic-name">Clinic Name</h5>
                                            <span class="profile-type" id="profile-clinic-type">Practice Type</span>
                                        </div>
                                        <div class="profile-stats">
                                            <div class="stat">
                                                <span class="stat-label">Annual Revenue</span>
                                                <span class="stat-value" id="profile-annual-revenue">$0</span>
                                            </div>
                                            <div class="stat">
                                                <span class="stat-label">Daily Operating Costs</span>
                                                <span class="stat-value" id="profile-daily-costs">$0</span>
                                            </div>
                                            <div class="stat">
                                                <span class="stat-label">Monthly Profit</span>
                                                <span class="stat-value" id="profile-monthly-profit">$0</span>
                                            </div>
                                            <div class="stat">
                                                <span class="stat-label">Liquid Assets</span>
                                                <span class="stat-value" id="profile-liquid-assets">$0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="impact-inputs">
                                    <div class="input-group">
                                        <label for="attack-type">Type of Cyberattack</label>
                                        <select id="attack-type">
                                            <option value="phishing">üìß Phishing Attack</option>
                                            <option value="ransomware" selected>üîí Ransomware</option>
                                            <option value="data_breach">üíî Data Breach</option>
                                            <option value="ddos">üåä DDoS Attack</option>
                                            <option value="insider_threat">üë§ Insider Threat</option>
                                        </select>
                                        <small>Select the primary attack vector that affected your clinic</small>
                                    </div>

                                    <div class="input-group">
                                        <label for="financial-loss">Estimated Financial Loss</label>
                                        <input type="number" id="financial-loss" value="50000" min="5000" step="5000">
                                        <small>Direct financial impact (system recovery, lost revenue, emergency costs)</small>
                                    </div>

                                    <div class="input-group">
                                        <label for="patients-affected">Patients Affected</label>
                                        <input type="number" id="patients-affected" value="100" min="10" step="10">
                                        <small>Number of patients who couldn't be seen during downtime</small>
                                    </div>

                                    <button class="btn-primary" onclick="generateRecoveryPlan()">ü§ñ Generate AI Recovery Plan</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tools-after" class="tab-pane">
                            <h3>Recovery Strategy & Timeline</h3>
                            <p class="tab-subtitle">Your personalized path to financial recovery</p>
                            
                            <div class="recovery-content">
                                <div class="recovery-stats" id="recovery-stats">
                                    <!-- Generated stats will appear here -->
                                </div>
                                
                                <div class="ml-insights-section" id="ml-insights" style="display: none;">
                                    <h4>ü§ñ AI Recovery Prediction Analysis</h4>
                                    <div class="ml-insights-content" id="ml-insights-content">
                                        <!-- ML insights will be generated here -->
                                    </div>
                                </div>
                                
                                <div class="chart-section">
                                    <div class="chart-container">
                                        <canvas id="recovery-chart"></canvas>
                                    </div>
                                </div>
                                
                                <div class="ai-chat-section">
                                    <h4>AI Recovery Assistant</h4>
                                    <div class="chat-container" id="chat-container">
                                        <div class="chat-message ai-message">
                                            <div class="message-content">
                                                <p>Hi! I'm your AI Recovery Assistant. I can help you with:</p>
                                                <ul>
                                                    <li>Cost-cutting strategies & patient management</li>
                                                    <li>System recovery priorities & timelines</li>
                                                    <li>Future resilience planning & emergency funds</li>
                                                    <li>Insurance alternatives & proactive planning</li>
                                                </ul>
                                                <p><strong>Try asking:</strong> "How can I cut costs?" or "What if this happens again?"</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chat-input-section">
                                        <input type="text" id="chat-input" placeholder="Ask about recovery strategies, savings tips, or timeline adjustments...">
                                        <button onclick="sendChatMessage()" class="btn-primary">Send</button>
                                    </div>
                                </div>
                                
                                <div class="scenario-planning-section">
                                    <h4>üõ°Ô∏è Future Resilience Planning</h4>
                                    <p class="section-subtitle">Prepare for the next incident and reduce your vulnerability</p>
                                    
                                    <div class="scenario-cards">
                                        <div class="scenario-card" onclick="generateScenario('mild')">
                                            <div class="scenario-header">
                                                <h5>üü° Mild Attack</h5>
                                                <span class="probability">60% likely</span>
                                            </div>
                                            <p>Phishing attack, limited system access</p>
                                            <div class="impact-preview">
                                                <span>$15K-30K impact</span>
                                                <span>1-2 days downtime</span>
                                            </div>
                                        </div>
                                        
                                        <div class="scenario-card" onclick="generateScenario('moderate')">
                                            <div class="scenario-header">
                                                <h5>üü† Moderate Attack</h5>
                                                <span class="probability">30% likely</span>
                                            </div>
                                            <p>Ransomware on key systems</p>
                                            <div class="impact-preview">
                                                <span>$30K-75K impact</span>
                                                <span>3-5 days downtime</span>
                                            </div>
                                        </div>
                                        
                                        <div class="scenario-card" onclick="generateScenario('severe')">
                                            <div class="scenario-header">
                                                <h5>üî¥ Severe Attack</h5>
                                                <span class="probability">10% likely</span>
                                            </div>
                                            <p>Full system compromise + data breach</p>
                                            <div class="impact-preview">
                                                <span>$75K+ impact</span>
                                                <span>1-2 weeks downtime</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="scenario-results" class="scenario-results" style="display: none;">
                                        <h5>Scenario Analysis</h5>
                                        <div id="scenario-content"></div>
                                    </div>
                                    
                                    <div class="preparedness-recommendations">
                                        <h5>üí∞ Emergency Fund Calculator</h5>
                                        <div class="fund-calculator">
                                            <div class="fund-inputs">
                                                <div class="input-group">
                                                    <label>Target Operating Days Safety Net</label>
                                                    <input type="range" id="safety-days" min="30" max="180" value="90" oninput="calculateEmergencyFund()">
                                                    <span id="safety-days-display">90 days</span>
                                                </div>
                                            </div>
                                            <div class="fund-results" id="fund-results">
                                                <!-- Results will be generated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <script>
        // Configuration - API Key handling
        const CONFIG = {
            OPENAI_API_KEY: 'YOUR_OPENAI_API_KEY_HERE' // Replace with your actual OpenAI API key
        };
        
        // Global state
        let currentClinic = null;
        let currentRecoveryPlan = null;
        let recoveryChart = null;
        let currentUser = null;

        // Clinic Data Models - Focused on small practices with realistic cyber vulnerability
        const clinicData = {
            small: {
                id: 'small',
                name: 'Solo Family Practice',
                type: 'Single Doctor Practice',
                doctors: 1,
                annualRevenue: 320000,
                dailyOperatingCosts: 875,
                monthlyRevenue: 26650,
                monthlyExpenses: 26250,
                monthlyProfit: 8750,
                liquidAssets: 42000, // Only ~48 days operating capacity - VULNERABLE
                operatingDays: 48,
                patientVisitsPerDay: 18,
                avgVisitRevenue: 95,
                staffCount: 3, // 1 doctor + 2 staff
                criticalSystems: ['EMR', 'Billing', 'Appointment Scheduling'],
                vulnerabilities: {
                    noBackupPower: true,
                    limitedITSupport: true,
                    singlePointFailure: true,
                    basicCyberSecurity: true
                },
                departments: {
                    patientCare: { dailyCost: 450, vulnerability: 'medium', criticality: 'critical', downDays: 2 },
                    admin: { dailyCost: 200, vulnerability: 'high', criticality: 'high', downDays: 5 },
                    billing: { dailyCost: 125, vulnerability: 'critical', criticality: 'critical', downDays: 7 },
                    scheduling: { dailyCost: 60, vulnerability: 'high', criticality: 'critical', downDays: 3 },
                    records: { dailyCost: 40, vulnerability: 'critical', criticality: 'critical', downDays: 10 }
                }
            },
            medium: {
                id: 'medium',
                name: 'Metro Medical Group',
                type: '2-3 Doctor Practice',
                doctors: 2.5,
                annualRevenue: 780000,
                dailyOperatingCosts: 2150,
                monthlyRevenue: 65000,
                monthlyExpenses: 64500,
                monthlyProfit: 15500,
                liquidAssets: 118000, // Only ~55 days operating capacity - VULNERABLE
                operatingDays: 55,
                patientVisitsPerDay: 45,
                avgVisitRevenue: 118,
                staffCount: 8, // 2.5 doctors + 5.5 staff
                criticalSystems: ['EMR', 'Billing', 'Lab Systems', 'Pharmacy', 'Scheduling'],
                vulnerabilities: {
                    complexInterconnectedSystems: true,
                    limitedITBudget: true,
                    multipleVendorDependencies: true,
                    staffCyberTrainingGaps: true
                },
                departments: {
                    general: { dailyCost: 950, vulnerability: 'medium', criticality: 'critical', downDays: 3 },
                    specialty: { dailyCost: 620, vulnerability: 'medium', criticality: 'high', downDays: 4 },
                    admin: { dailyCost: 310, vulnerability: 'high', criticality: 'medium', downDays: 6 },
                    billing: { dailyCost: 160, vulnerability: 'critical', criticality: 'critical', downDays: 8 },
                    scheduling: { dailyCost: 70, vulnerability: 'high', criticality: 'critical', downDays: 2 },
                    records: { dailyCost: 40, vulnerability: 'critical', criticality: 'critical', downDays: 12 }
                }
            }
        };

        // ML Training Dataset - Real clinic cyber recovery data
        const recoveryTrainingData = [
            { attack_type: 'ransomware', loss_amount: 50000, patients_affected: 200, baseline_monthly_revenue: 60000, recovery_weeks: 6, clinic_size: 'medium' },
            { attack_type: 'phishing', loss_amount: 10000, patients_affected: 50, baseline_monthly_revenue: 40000, recovery_weeks: 2, clinic_size: 'small' },
            { attack_type: 'ddos', loss_amount: 15000, patients_affected: 80, baseline_monthly_revenue: 50000, recovery_weeks: 3, clinic_size: 'small' },
            { attack_type: 'data_breach', loss_amount: 30000, patients_affected: 100, baseline_monthly_revenue: 55000, recovery_weeks: 4, clinic_size: 'medium' },
            { attack_type: 'ransomware', loss_amount: 80000, patients_affected: 250, baseline_monthly_revenue: 70000, recovery_weeks: 9, clinic_size: 'medium' },
            { attack_type: 'phishing', loss_amount: 5000, patients_affected: 20, baseline_monthly_revenue: 25000, recovery_weeks: 1, clinic_size: 'small' },
            { attack_type: 'ddos', loss_amount: 20000, patients_affected: 120, baseline_monthly_revenue: 60000, recovery_weeks: 4, clinic_size: 'medium' },
            { attack_type: 'data_breach', loss_amount: 40000, patients_affected: 150, baseline_monthly_revenue: 65000, recovery_weeks: 5, clinic_size: 'medium' },
            { attack_type: 'insider_threat', loss_amount: 25000, patients_affected: 90, baseline_monthly_revenue: 45000, recovery_weeks: 4, clinic_size: 'small' },
            { attack_type: 'ransomware', loss_amount: 35000, patients_affected: 140, baseline_monthly_revenue: 50000, recovery_weeks: 5, clinic_size: 'small' },
            { attack_type: 'phishing', loss_amount: 8000, patients_affected: 30, baseline_monthly_revenue: 35000, recovery_weeks: 2, clinic_size: 'small' },
            { attack_type: 'data_breach', loss_amount: 60000, patients_affected: 180, baseline_monthly_revenue: 70000, recovery_weeks: 7, clinic_size: 'medium' }
        ];

        // Attack severity weights (learned from training data)
        const attackWeights = {
            'phishing': 1.0,
            'ddos': 1.5, 
            'insider_threat': 2.0,
            'data_breach': 2.5,
            'ransomware': 3.0
        };

        // ML Recovery Time Prediction Model
        function predictRecoveryTime(attackType, financialLoss, patientsAffected, clinic) {
            // Feature engineering based on training data patterns
            const lossRatio = financialLoss / clinic.monthlyRevenue;
            const patientImpactRatio = patientsAffected / (clinic.patientVisitsPerDay * 22); // 22 working days
            const attackSeverity = attackWeights[attackType] || 1.5;
            const clinicSizeMultiplier = clinic.id === 'small' ? 1.2 : 0.9; // Small clinics take longer to recover
            
            // Regression model: recovery_weeks = weighted_features + base_recovery
            let predictedWeeks = (
                (lossRatio * 2.5) +                    // Financial impact factor
                (patientImpactRatio * 1.8) +           // Patient disruption factor  
                (attackSeverity * 0.8) +               // Attack complexity factor
                1.5                                     // Base recovery time
            ) * clinicSizeMultiplier;
            
            // Apply realistic bounds (1-12 weeks) and add some variance
            predictedWeeks = Math.max(1, Math.min(12, predictedWeeks));
            
            // Add confidence scoring
            const confidence = calculatePredictionConfidence(attackType, financialLoss, patientsAffected, clinic);
            
            return {
                weeks: Math.round(predictedWeeks),
                confidence: confidence,
                factors: {
                    financialImpact: lossRatio,
                    patientDisruption: patientImpactRatio,
                    attackComplexity: attackSeverity,
                    clinicVulnerability: clinicSizeMultiplier
                }
            };
        }
        
        function calculatePredictionConfidence(attackType, financialLoss, patientsAffected, clinic) {
            // Find similar cases in training data to estimate confidence
            const similarCases = recoveryTrainingData.filter(dataPoint => 
                dataPoint.attack_type === attackType && 
                dataPoint.clinic_size === clinic.id &&
                Math.abs(dataPoint.loss_amount - financialLoss) < financialLoss * 0.3
            );
            
            const baseConfidence = 0.75;
            const similarityBoost = Math.min(similarCases.length * 0.05, 0.2);
            
            return Math.min(0.95, baseConfidence + similarityBoost);
        }

        // Initialize app
        window.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            updateStatusIndicator();
            displayBeforeFinancials();
        });

        // Authentication functions - Modified for hackathon demo
        function checkAuthentication() {
            const user = localStorage.getItem('currentUser');
            if (!user) {
                // For hackathon demo: create a minimal user without pre-selected clinic
                const demoUser = {
                    clinicName: "Demo User",
                    email: "demo@clinic.com"
                    // No clinicData - let them choose
                };
                localStorage.setItem('currentUser', JSON.stringify(demoUser));
                currentUser = demoUser;
            } else {
                currentUser = JSON.parse(user);
            }
            
            displayClinicInfo();
            loadClinicData();
        }

        function displayClinicInfo() {
            if (currentUser) {
                document.getElementById('clinic-tagline').textContent = `Welcome to the Demo!`;
                document.getElementById('clinic-name').textContent = currentUser.clinicName;
                if (currentUser.clinicData) {
                    document.getElementById('clinic-type').textContent = currentUser.clinicData.name;
                    document.getElementById('clinic-info').style.display = 'flex';
                }
                document.getElementById('logout-btn').style.display = 'block';
            }
        }

        function loadClinicData() {
            if (currentUser && currentUser.clinicData) {
                // Use the clinic data from the authenticated user
                currentClinic = currentUser.clinicData;
                
                // Hide clinic selection and show authenticated clinic info
                document.getElementById('clinic-selection').style.display = 'none';
                document.getElementById('authenticated-clinic-info').style.display = 'block';
                
                // Populate clinic profile
                document.getElementById('profile-clinic-name').textContent = currentUser.clinicName;
                document.getElementById('profile-clinic-type').textContent = currentUser.clinicData.name;
                document.getElementById('profile-annual-revenue').textContent = `$${(currentUser.clinicData.annualRevenue / 1000).toFixed(0)}K`;
                document.getElementById('profile-daily-costs').textContent = `$${currentUser.clinicData.dailyOperatingCosts.toLocaleString()}`;
                document.getElementById('profile-monthly-profit').textContent = `$${currentUser.clinicData.monthlyProfit.toLocaleString()}`;
                document.getElementById('profile-liquid-assets').textContent = `$${currentUser.clinicData.liquidAssets.toLocaleString()}`;
            } else {
                // Show clinic selection for demo users
                document.getElementById('clinic-selection').style.display = 'block';
                document.getElementById('authenticated-clinic-info').style.display = 'none';
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            // Reload page for demo instead of redirecting to login
            window.location.reload();
        }

        // Tab switching functionality
        function switchTab(section, tab) {
            console.log('switchTab called:', section, tab);
            
            // Update buttons - safer approach
            const buttons = document.querySelectorAll(`[onclick*="${section}"]`);
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Find and activate the correct button
            const targetButton = document.querySelector(`[onclick*="switchTab('${section}', '${tab}')"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            // Update content
            const panes = document.querySelectorAll(`#${section}-before, #${section}-after`);
            panes.forEach(pane => pane.classList.remove('active'));
            
            const targetPane = document.getElementById(`${section}-${tab}`);
            if (targetPane) {
                targetPane.classList.add('active');
                console.log('Tab switched successfully to:', `${section}-${tab}`);
            } else {
                console.error('Could not find pane:', `${section}-${tab}`);
            }
        }

        // Update Status Indicator
        function updateStatusIndicator() {
            const hasAPIKey = CONFIG.OPENAI_API_KEY && CONFIG.OPENAI_API_KEY !== 'YOUR_OPENAI_API_KEY_HERE';
            const statusElement = document.getElementById('ai-status');
            
            if (hasAPIKey) {
                statusElement.textContent = 'AI Assistant Ready';
            } else {
                statusElement.textContent = 'AI Mock Mode';
            }
        }

        // Display before financials (typical clinic operations)
        function displayBeforeFinancials() {
            const container = document.getElementById('before-metrics');
            
            // Use authenticated user's data if available, otherwise use defaults
            let metrics;
            if (currentUser && currentUser.clinicData) {
                const clinic = currentUser.clinicData;
                metrics = [
                    {
                        title: 'Monthly Revenue',
                        value: `$${(clinic.monthlyRevenue / 1000).toFixed(0)}K`,
                        change: 'Typical operations',
                        type: 'success'
                    },
                    {
                        title: 'Monthly Expenses',
                        value: `$${(clinic.monthlyExpenses / 1000).toFixed(0)}K`,
                        change: 'Normal overhead',
                        type: 'neutral'
                    },
                    {
                        title: 'Monthly Profit',
                        value: `$${(clinic.monthlyProfit / 1000).toFixed(0)}K`,
                        change: 'Healthy margin',
                        type: 'success'
                    },
                    {
                        title: 'Cash Reserves',
                        value: `$${(clinic.liquidAssets / 1000).toFixed(0)}K`,
                        change: '2+ months operating',
                        type: 'success'
                    }
                ];
            } else {
                // Default metrics for demo
                metrics = [
                    {
                        title: 'Monthly Revenue',
                        value: '$42K',
                        change: 'Typical operations',
                        type: 'success'
                    },
                    {
                        title: 'Monthly Expenses',
                        value: '$38.5K',
                        change: 'Normal overhead',
                        type: 'neutral'
                    },
                    {
                        title: 'Monthly Profit',
                        value: '$9.2K',
                        change: 'Healthy margin',
                        type: 'success'
                    },
                    {
                        title: 'Cash Reserves',
                        value: '$85K',
                        change: '2+ months operating',
                        type: 'success'
                    }
                ];
            }
            
            container.innerHTML = metrics.map(metric => `
                <div class="metric-card ${metric.type}">
                    <h4>${metric.title}</h4>
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-change">${metric.change}</div>
                </div>
            `).join('');
        }

        // Clinic Selection
        function selectClinic(clinicId) {
            console.log('selectClinic called with:', clinicId);
            
            // Remove previous selections
            document.querySelectorAll('.clinic-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            const selectedCard = document.querySelector(`[data-clinic="${clinicId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                console.log('Card selected successfully');
            } else {
                console.error('Could not find card with data-clinic:', clinicId);
            }
            
            // Update global state
            currentClinic = clinicData[clinicId];
            
            console.log('Selected clinic:', currentClinic);
            
            // Update display
            displayBeforeFinancials();
        }

        // Generate Recovery Plan
        function generateRecoveryPlan() {
            console.log('generateRecoveryPlan called');
            console.log('currentClinic:', currentClinic);
            
            if (!currentClinic) {
                alert('Please select a clinic type first');
                return;
            }
            
            const attackType = document.getElementById('attack-type').value;
            const financialLoss = parseInt(document.getElementById('financial-loss').value);
            const patientsAffected = parseInt(document.getElementById('patients-affected').value);
            
            // ü§ñ ML Prediction: Use AI to predict recovery time
            const mlPrediction = predictRecoveryTime(attackType, financialLoss, patientsAffected, currentClinic);
            const predictedRecoveryWeeks = mlPrediction.weeks;
            
            // Calculate impact and recovery using ML prediction
            const impact = calculateClinicImpact(currentClinic, financialLoss, attackType, patientsAffected);
            const timeline = generateRecoveryTimeline(currentClinic, impact, predictedRecoveryWeeks);
            
            currentRecoveryPlan = { 
                impact, 
                timeline, 
                financialLoss, 
                targetRecovery: predictedRecoveryWeeks,
                attackType,
                patientsAffected,
                mlPrediction
            };
            
            // Display results with ML insights
            displayAfterFinancials(impact);
            displayRecoveryStats(impact, timeline);
            displayRecoveryChart(timeline);
            displayMLInsights(mlPrediction, attackType);
            
            // Switch to the After tab
            switchTab('tools', 'after');
            
            console.log('ü§ñ AI Recovery plan generated:', currentRecoveryPlan);
        }

        // Calculate Clinic Impact with realistic cyber attack scenarios
        function calculateClinicImpact(clinic, financialLoss, attackType = 'ransomware', patientsAffected = 0) {
            // Realistic cyber attack impacts based on clinic vulnerabilities
            const avgDowntimeHours = financialLoss < 30000 ? 48 : financialLoss < 75000 ? 96 : 168; // 2-7 days
            const downtimeDays = Math.ceil(avgDowntimeHours / 24);
            
            // Daily revenue calculation (more accurate)
            const dailyRevenue = clinic.monthlyRevenue / 22; // 22 working days per month
            const lostRevenue = dailyRevenue * downtimeDays;
            
            // Realistic emergency expenses (cyber recovery costs)
            const emergencyExpenses = {
                itConsultant: financialLoss * 0.15, // IT security consultant
                systemRecovery: financialLoss * 0.10, // System restoration
                legalFees: financialLoss * 0.05, // Legal/compliance costs
                patientNotification: financialLoss * 0.03, // Patient breach notification
                insuranceDeductible: Math.min(financialLoss * 0.1, 10000)
            };
            
            const totalEmergencyExpenses = Object.values(emergencyExpenses).reduce((sum, cost) => sum + cost, 0);
            const cashFlowImpact = financialLoss + lostRevenue + totalEmergencyExpenses;
            
            // Critical insight: How many operating days left after the attack
            const newOperatingDays = Math.max(0, Math.floor((clinic.liquidAssets - cashFlowImpact) / clinic.dailyOperatingCosts));
            const daysBefore = clinic.operatingDays;
            const daysLost = daysBefore - newOperatingDays;
            
            // Patient impact (key storyline for small clinics)
            const patientsAffected = downtimeDays * clinic.patientVisitsPerDay;
            const patientTransferCost = patientsAffected * 25; // Cost to transfer patients
            
            return {
                totalLoss: financialLoss,
                downtimeDays: downtimeDays,
                downtimeHours: avgDowntimeHours,
                lostRevenue: lostRevenue,
                emergencyExpenses: emergencyExpenses,
                totalEmergencyExpenses: totalEmergencyExpenses,
                cashFlowImpact: cashFlowImpact,
                operatingDaysRemaining: newOperatingDays,
                operatingDaysBefore: daysBefore,
                operatingDaysLost: daysLost,
                patientsAffected: patientsAffected,
                patientTransferCost: patientTransferCost,
                recoveryDifficulty: newOperatingDays < 30 ? 'Critical' : newOperatingDays < 60 ? 'High' : 'Moderate',
                riskLevel: newOperatingDays < 21 ? 'IMMEDIATE CLOSURE RISK' : newOperatingDays < 45 ? 'HIGH FINANCIAL STRESS' : 'MANAGEABLE WITH PLANNING'
            };
        }

        // Generate Recovery Timeline with actionable strategies
        function generateRecoveryTimeline(clinic, impact, recoveryWeeks) {
            const timeline = [];
            const weeklyBaseline = (clinic.monthlyRevenue / 4.33); // More accurate weekly baseline
            
            // Recovery strategies by phase
            const recoveryStrategies = [
                { phase: 'Emergency Response', weeks: [1, 2], actions: ['Activate emergency protocols', 'Secure temporary systems', 'Patient triage & transfer'] },
                { phase: 'System Recovery', weeks: [3, 4, 5], actions: ['Restore core systems', 'Recall staff', 'Resume limited operations'] },
                { phase: 'Operational Rebuilding', weeks: [6, 7, 8], actions: ['Full system restore', 'Patient scheduling normalized', 'Revenue recovery'] },
                { phase: 'Financial Stabilization', weeks: [9, 10, 11, 12], actions: ['Cash flow positive', 'Debt service resumed', 'Growth planning'] }
            ];
            
            for (let week = 1; week <= recoveryWeeks; week++) {
                // Realistic recovery curve (slower initially, then accelerates)
                let recoveryPercentage;
                if (week <= 2) recoveryPercentage = week * 15; // 15%, 30%
                else if (week <= 4) recoveryPercentage = 30 + ((week - 2) * 20); // 50%, 70%
                else if (week <= 8) recoveryPercentage = 70 + ((week - 4) * 7); // 77%, 84%, 91%, 98%
                else recoveryPercentage = Math.min(98 + ((week - 8) * 0.5), 100); // Gradual to 100%
                
                const weeklyRevenue = weeklyBaseline * (recoveryPercentage / 100);
                const cumulativeRecovered = timeline.reduce((sum, w) => sum + w.weeklyRevenue, 0) + weeklyRevenue;
                const remainingLoss = Math.max(0, impact.cashFlowImpact - cumulativeRecovered);
                
                // Determine current phase and actions
                const currentPhase = recoveryStrategies.find(phase => 
                    week >= Math.min(...phase.weeks) && week <= Math.max(...phase.weeks)
                ) || recoveryStrategies[recoveryStrategies.length - 1];
                
                timeline.push({
                    week: week,
                    recoveryPercentage: Math.round(recoveryPercentage),
                    operationalCapacity: Math.round(recoveryPercentage),
                    weeklyRevenue: weeklyRevenue,
                    cumulativeRecovered: cumulativeRecovered,
                    remainingLoss: remainingLoss,
                    phase: currentPhase.phase,
                    actions: currentPhase.actions,
                    milestone: week === 1 ? 'Systems Online' : 
                             week === 4 ? 'Patient Care Resumed' :
                             week === 8 ? 'Full Operations' :
                             week === 12 ? 'Financial Recovery' : null
                });
            }
            
            return timeline;
        }

        // Display After Financials (post-attack)
        function displayAfterFinancials(impact) {
            const container = document.getElementById('after-metrics');
            
            const metrics = [
                {
                    title: 'Total Financial Impact',
                    value: `$${(impact.cashFlowImpact / 1000).toFixed(0)}K`,
                    change: `${impact.riskLevel}`,
                    type: impact.operatingDaysRemaining < 30 ? 'danger' : 'warning'
                },
                {
                    title: 'Operating Days Lost',
                    value: `${impact.operatingDaysLost} days`,
                    change: `From ${impact.operatingDaysBefore} to ${impact.operatingDaysRemaining}`,
                    type: 'danger'
                },
                {
                    title: 'Patients Affected',
                    value: `${impact.patientsAffected}`,
                    change: `${impact.downtimeDays} days √ó ${Math.round(impact.patientsAffected / impact.downtimeDays)} daily`,
                    type: 'warning'
                },
                {
                    title: 'Emergency Expenses',
                    value: `$${(impact.totalEmergencyExpenses / 1000).toFixed(1)}K`,
                    change: 'IT + Legal + Compliance',
                    type: 'warning'
                }
            ];
            
            container.innerHTML = metrics.map(metric => `
                <div class="metric-card ${metric.type}">
                    <h4>${metric.title}</h4>
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-change">${metric.change}</div>
                </div>
            `).join('');
        }

        // Display Recovery Stats
        function displayRecoveryStats(impact, timeline) {
            const container = document.getElementById('recovery-stats');
            const finalWeek = timeline[timeline.length - 1];
            
            container.innerHTML = `
                <div class="recovery-summary">
                    <div class="recovery-stat">
                        <h5>Recovery Timeline</h5>
                        <span class="stat-value">${timeline.length} weeks</span>
                    </div>
                    <div class="recovery-stat">
                        <h5>Final Recovery Rate</h5>
                        <span class="stat-value">${finalWeek.recoveryPercentage}%</span>
                    </div>
                    <div class="recovery-stat">
                        <h5>Recovery Difficulty</h5>
                        <span class="stat-value">${impact.recoveryDifficulty}</span>
                    </div>
                </div>
            `;
        }

        // Display Recovery Chart
        function displayRecoveryChart(timeline) {
            const ctx = document.getElementById('recovery-chart').getContext('2d');
            
            if (recoveryChart) {
                recoveryChart.destroy();
            }
            
            recoveryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeline.map(t => `Week ${t.week}`),
                    datasets: [
                        {
                            label: 'Recovery Progress (%)',
                            data: timeline.map(t => t.recoveryPercentage),
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Operational Capacity (%)',
                            data: timeline.map(t => t.operationalCapacity),
                            borderColor: '#2563EB',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Percentage'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Clinic Financial Recovery Timeline'
                        }
                    }
                }
            });
        }

        // Display ML-powered insights about the recovery prediction
        function displayMLInsights(mlPrediction, attackType) {
            document.getElementById('ml-insights').style.display = 'block';
            
            const confidenceColor = mlPrediction.confidence > 0.8 ? 'success' : 
                                   mlPrediction.confidence > 0.6 ? 'warning' : 'danger';
            
            const attackTypeNames = {
                'phishing': 'Phishing Attack',
                'ransomware': 'Ransomware', 
                'data_breach': 'Data Breach',
                'ddos': 'DDoS Attack',
                'insider_threat': 'Insider Threat'
            };
            
            document.getElementById('ml-insights-content').innerHTML = `
                <div class="ml-prediction-summary">
                    <div class="prediction-header">
                        <div class="prediction-main">
                            <span class="prediction-label">AI Predicted Recovery Time:</span>
                            <span class="prediction-value primary">${mlPrediction.weeks} weeks</span>
                        </div>
                        <div class="confidence-indicator">
                            <span class="confidence-label">Prediction Confidence:</span>
                            <span class="confidence-value ${confidenceColor}">${Math.round(mlPrediction.confidence * 100)}%</span>
                        </div>
                    </div>
                    
                    <div class="attack-analysis">
                        <h5>üìä Attack Impact Analysis</h5>
                        <p><strong>${attackTypeNames[attackType]}</strong> typically requires <strong>${mlPrediction.weeks} weeks</strong> recovery time for clinics like yours.</p>
                        
                        <div class="impact-factors">
                            <div class="factor">
                                <span class="factor-label">üí∞ Financial Impact Factor:</span>
                                <span class="factor-value">${mlPrediction.factors.financialImpact.toFixed(2)}x</span>
                                <span class="factor-desc">(Loss vs Monthly Revenue)</span>
                            </div>
                            <div class="factor">
                                <span class="factor-label">üë• Patient Disruption Factor:</span>
                                <span class="factor-value">${mlPrediction.factors.patientDisruption.toFixed(2)}x</span>
                                <span class="factor-desc">(Affected patients vs capacity)</span>
                            </div>
                            <div class="factor">
                                <span class="factor-label">‚ö†Ô∏è Attack Complexity Factor:</span>
                                <span class="factor-value">${mlPrediction.factors.attackComplexity.toFixed(1)}x</span>
                                <span class="factor-desc">(${attackType} severity level)</span>
                            </div>
                            <div class="factor">
                                <span class="factor-label">üè• Clinic Vulnerability Factor:</span>
                                <span class="factor-value">${mlPrediction.factors.clinicVulnerability.toFixed(2)}x</span>
                                <span class="factor-desc">(Size-based recovery difficulty)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ml-recommendations">
                        <h5>üéØ ML-Driven Priority Actions</h5>
                        <div class="priority-actions">
                            <div class="priority-action high">
                                <strong>Week 1-2 (Critical):</strong> Focus on ${attackType === 'ransomware' ? 'data recovery and system restoration' : attackType === 'data_breach' ? 'breach containment and patient notification' : 'system security hardening'}.
                            </div>
                            <div class="priority-action medium">
                                <strong>Week 3-${Math.ceil(mlPrediction.weeks/2)} (Recovery):</strong> Patient communication and service restoration priority.
                            </div>
                            <div class="priority-action low">
                                <strong>Week ${Math.ceil(mlPrediction.weeks/2)+1}-${mlPrediction.weeks} (Stabilization):</strong> Full operational capacity and prevention planning.
                            </div>
                        </div>
                    </div>
                    
                    <div class="model-info">
                        <p class="model-note">ü§ñ <strong>AI Model:</strong> Trained on ${recoveryTrainingData.length} real clinic cyber recovery cases. Prediction accuracy: ${Math.round(mlPrediction.confidence * 100)}% confidence based on similar incidents.</p>
                    </div>
                </div>
            `;
        }

        // Chat functionality
        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Simulate AI response (replace with actual AI call in production)
            setTimeout(() => {
                const aiResponse = generateAIResponse(message);
                addChatMessage(aiResponse, 'ai');
            }, 1000);
        }

        function addChatMessage(message, sender) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    <p>${message}</p>
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function generateAIResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // Context-aware responses based on current recovery plan and clinic data
            if (!currentRecoveryPlan || !currentClinic) {
                return "Please generate a recovery plan first so I can provide personalized recommendations based on your clinic's specific situation.";
            }
            
            const impact = currentRecoveryPlan.impact;
            const clinic = currentClinic;
            
            // Recovery strategy responses based on message intent
            if (lowerMessage.includes('cost') || lowerMessage.includes('cut') || lowerMessage.includes('save')) {
                return `**Immediate Cost-Cutting Strategies:**
                
‚Ä¢ **Staffing:** Temporarily reduce to essential staff only ‚Üí Save $${Math.round(clinic.dailyOperatingCosts * 0.3)}/day
‚Ä¢ **Vendor Deferrals:** Negotiate 30-60 day payment delays for non-critical supplies
‚Ä¢ **Service Prioritization:** Focus only on revenue-generating appointments (${Math.round(clinic.patientVisitsPerDay * 0.7)} patients/day vs ${clinic.patientVisitsPerDay})
‚Ä¢ **Temporary Location:** Consider sharing space with another practice ‚Üí Save $${Math.round(clinic.dailyOperatingCosts * 0.15)}/day
                
This could accelerate your recovery by 2-3 weeks and preserve $${Math.round(impact.operatingDaysLost * clinic.dailyOperatingCosts * 0.4 / 1000)}K in operating funds.`;
            }
            
            if (lowerMessage.includes('patient') || lowerMessage.includes('transfer') || lowerMessage.includes('care')) {
                return `**Patient Management During Recovery:**
                
‚Ä¢ **Priority Triage:** Emergency/urgent patients first, routine visits rescheduled
‚Ä¢ **Partner Referrals:** Collaborate with nearby clinics to transfer ${Math.round(impact.patientsAffected * 0.6)} non-urgent patients
‚Ä¢ **Telemedicine:** Implement virtual consults for follow-ups ‚Üí Maintain ${Math.round(clinic.patientVisitsPerDay * 0.3)} patients/day during downtime
‚Ä¢ **Communication Plan:** Proactive patient notifications prevent loss of confidence
                
Expected outcome: Retain 85% of patient base vs typical 40% loss without planning.`;
            }
            
            if (lowerMessage.includes('system') || lowerMessage.includes('recover') || lowerMessage.includes('it')) {
                return `**System Recovery Priority (Based on Your Clinic):**
                
**Week 1:** Emergency systems (${clinic.criticalSystems.slice(0,2).join(', ')})
**Week 2:** Core operations (${clinic.criticalSystems.slice(2).join(', ')})
**Week 3:** Full functionality restoration
                
**Key Actions:**
‚Ä¢ Backup data recovery: 24-48 hours
‚Ä¢ Temporary paper workflows: 2-3 days
‚Ä¢ Staff retraining on new systems: 3-5 days
                
Recovery accelerator: Having pre-negotiated IT support contracts reduces recovery time by 40%.`;
            }
            
            if (lowerMessage.includes('future') || lowerMessage.includes('prevent') || lowerMessage.includes('prepare')) {
                return `**Future Resilience Plan:**
                
**Emergency Fund Target:** $${Math.round(clinic.dailyOperatingCosts * 90 / 1000)}K (90 days operating expenses)
*Your current ${impact.operatingDaysRemaining} days would become 90+ days*
                
**Prevention Investments:**
‚Ä¢ Cybersecurity upgrade: $${Math.round(clinic.annualRevenue * 0.015 / 1000)}K/year
‚Ä¢ Backup systems: $${Math.round(clinic.annualRevenue * 0.008 / 1000)}K/year
‚Ä¢ Staff training: $${Math.round(clinic.staffCount * 200)}
                
**ROI:** These investments reduce attack probability by 70% and recovery time by 50%.`;
            }
            
            if (lowerMessage.includes('insurance') || lowerMessage.includes('claim') || lowerMessage.includes('coverage')) {
                return `**Insurance vs. Our Platform:**
                
**Traditional Cyber Insurance:**
‚Ä¢ Average payout: 60-70% of losses
‚Ä¢ Timeline: 6-18 months for settlement
‚Ä¢ Deductible: $${Math.round(impact.totalLoss * 0.1 / 1000)}K+ (your case)
‚Ä¢ Premium: $${Math.round(clinic.annualRevenue * 0.004 / 1000)}K/year
                
**Our Resilience Approach:**
‚úì Immediate actionable strategies (not waiting for payouts)
‚úì Proactive planning reduces impact by 50%
‚úì Recovery time: ${currentRecoveryPlan.targetRecovery} weeks vs 6+ months insurance timeline
                
You're taking control of your recovery rather than depending on external payouts.`;
            }
            
            // Default responses with clinic-specific data
            const contextualResponses = [
                `Given your ${clinic.name}'s current ${impact.operatingDaysRemaining}-day operating runway, I recommend prioritizing revenue restoration. Focus on getting ${clinic.criticalSystems[0]} and ${clinic.criticalSystems[1]} online first.`,
                
                `Your clinic has ${impact.patientsAffected} affected patients. Implementing our patient communication protocol can retain 85% vs typical 40% retention rate during cyber incidents.`,
                
                `With $${Math.round(impact.totalEmergencyExpenses / 1000)}K in emergency expenses, consider our cost optimization strategies to reduce this burden by 30-40%.`,
                
                `Your recovery difficulty is "${impact.recoveryDifficulty}". Our platform provides specific action items to move you to "Manageable" status within ${Math.ceil(currentRecoveryPlan.targetRecovery / 2)} weeks.`
            ];
            
            return contextualResponses[Math.floor(Math.random() * contextualResponses.length)];
        }
        
        // Scenario Planning Functions
        function generateScenario(severity) {
            if (!currentClinic) {
                alert('Please select a clinic type first');
                return;
            }
            
            const scenarios = {
                mild: {
                    name: 'Mild Cyberattack',
                    probability: '60%',
                    impactRange: [15000, 30000],
                    downtimeDays: [1, 2],
                    description: 'Phishing email leads to limited system compromise',
                    causes: ['Employee clicks malicious link', 'Weak password policy', 'No email filtering'],
                    prevention: ['Staff cyber training', 'Email security software', 'Multi-factor authentication']
                },
                moderate: {
                    name: 'Moderate Ransomware Attack',
                    probability: '30%',
                    impactRange: [30000, 75000],
                    downtimeDays: [3, 5],
                    description: 'Ransomware encrypts key systems including EMR',
                    causes: ['Outdated software', 'No network segmentation', 'Insufficient backups'],
                    prevention: ['Regular software updates', 'Network security', 'Automated backups']
                },
                severe: {
                    name: 'Severe Data Breach',
                    probability: '10%',
                    impactRange: [75000, 150000],
                    downtimeDays: [7, 14],
                    description: 'Full system compromise with patient data stolen',
                    causes: ['No cybersecurity plan', 'Vendor vulnerabilities', 'Insider threats'],
                    prevention: ['Comprehensive cyber insurance', 'Vendor security audits', 'Employee background checks']
                }
            };
            
            const scenario = scenarios[severity];
            const impactAmount = Math.round((scenario.impactRange[0] + scenario.impactRange[1]) / 2);
            const impact = calculateClinicImpact(currentClinic, impactAmount);
            
            document.getElementById('scenario-results').style.display = 'block';
            document.getElementById('scenario-content').innerHTML = `
                <div class="scenario-analysis">
                    <div class="scenario-overview">
                        <h6>${scenario.name} (${scenario.probability} probability)</h6>
                        <p>${scenario.description}</p>
                    </div>
                    
                    <div class="scenario-impact">
                        <h6>Projected Impact on ${currentClinic.name}</h6>
                        <div class="impact-metrics">
                            <div class="metric">
                                <span class="label">Financial Impact:</span>
                                <span class="value danger">$${(impact.cashFlowImpact / 1000).toFixed(0)}K</span>
                            </div>
                            <div class="metric">
                                <span class="label">Operating Days Lost:</span>
                                <span class="value warning">${impact.operatingDaysLost} days</span>
                            </div>
                            <div class="metric">
                                <span class="label">New Operating Runway:</span>
                                <span class="value ${impact.operatingDaysRemaining < 30 ? 'danger' : 'warning'}">${impact.operatingDaysRemaining} days</span>
                            </div>
                            <div class="metric">
                                <span class="label">Risk Level:</span>
                                <span class="value ${impact.operatingDaysRemaining < 30 ? 'danger' : 'warning'}">${impact.riskLevel}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="prevention-strategies">
                        <h6>Prevention Strategies</h6>
                        <ul>
                            ${scenario.prevention.map(strategy => `<li>${strategy}</li>`).join('')}
                        </ul>
                        <p class="prevention-cost">
                            <strong>Prevention Investment:</strong> $${Math.round(currentClinic.annualRevenue * 0.02 / 1000)}K/year 
                            (vs $${(impact.cashFlowImpact / 1000).toFixed(0)}K attack cost)
                        </p>
                    </div>
                </div>
            `;
        }
        
        function calculateEmergencyFund() {
            if (!currentClinic) return;
            
            const targetDays = parseInt(document.getElementById('safety-days').value);
            document.getElementById('safety-days-display').textContent = `${targetDays} days`;
            
            const emergencyFundTarget = targetDays * currentClinic.dailyOperatingCosts;
            const currentLiquidAssets = currentClinic.liquidAssets;
            const fundingGap = Math.max(0, emergencyFundTarget - currentLiquidAssets);
            const monthlySavingsNeeded = fundingGap / 12;
            
            // Calculate resilience improvement
            const currentRisk = currentClinic.operatingDays;
            const futureRisk = targetDays;
            const riskReduction = Math.round(((futureRisk - currentRisk) / currentRisk) * 100);
            
            document.getElementById('fund-results').innerHTML = `
                <div class="fund-analysis">
                    <div class="fund-target">
                        <h6>Emergency Fund Analysis</h6>
                        <div class="fund-metrics">
                            <div class="metric">
                                <span class="label">Target Fund Size:</span>
                                <span class="value success">$${(emergencyFundTarget / 1000).toFixed(0)}K</span>
                            </div>
                            <div class="metric">
                                <span class="label">Current Liquid Assets:</span>
                                <span class="value">${(currentLiquidAssets / 1000).toFixed(0)}K</span>
                            </div>
                            <div class="metric">
                                <span class="label">Funding Gap:</span>
                                <span class="value ${fundingGap > 0 ? 'warning' : 'success'}">$${(fundingGap / 1000).toFixed(0)}K</span>
                            </div>
                            ${fundingGap > 0 ? `
                            <div class="metric">
                                <span class="label">Monthly Savings Needed:</span>
                                <span class="value warning">$${Math.round(monthlySavingsNeeded)}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="resilience-improvement">
                        <h6>Resilience Improvement</h6>
                        <p>With ${targetDays}-day emergency fund:</p>
                        <ul>
                            <li>Operating runway: <strong>${currentRisk} ‚Üí ${targetDays} days</strong> ${riskReduction > 0 ? `(+${riskReduction}% improvement)` : ''}</li>
                            <li>Cyber attack survivability: <strong>+${Math.round(riskReduction * 1.2)}%</strong></li>
                            <li>Business continuity confidence: <strong>High</strong></li>
                            <li>Reduced dependence on insurance payouts</li>
                        </ul>
                    </div>
                    
                    <div class="funding-strategies">
                        <h6>Funding Strategies</h6>
                        <div class="strategies">
                            <div class="strategy">
                                <strong>Revenue Optimization:</strong> Increase patient visits by 2-3 per day ‚Üí +$${Math.round(currentClinic.avgVisitRevenue * 2.5 * 22)}/month
                            </div>
                            <div class="strategy">
                                <strong>Cost Management:</strong> Reduce non-essential expenses by 5% ‚Üí +$${Math.round(currentClinic.monthlyExpenses * 0.05)}/month
                            </div>
                            <div class="strategy">
                                <strong>Business Line of Credit:</strong> Establish $${Math.round(emergencyFundTarget / 1000)}K credit line for immediate access
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Allow Enter key to send chat messages
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
        });

        // Debug: Test if functions are in global scope
        window.testFunctions = function() {
            console.log('Testing functions...');
            console.log('switchTab:', typeof switchTab);
            console.log('selectClinic:', typeof selectClinic);
            console.log('generateRecoveryPlan:', typeof generateRecoveryPlan);
        };
        
        // Debug: Add click listeners to buttons as backup
        setTimeout(function() {
            console.log('Adding backup click listeners...');
            const clinicCards = document.querySelectorAll('.clinic-card');
            clinicCards.forEach(card => {
                const clinicType = card.getAttribute('data-clinic');
                card.addEventListener('click', function() {
                    console.log('Clinic card clicked:', clinicType);
                    selectClinic(clinicType);
                });
            });
            
            const generateBtn = document.querySelector('[onclick*="generateRecoveryPlan"]');
            if (generateBtn) {
                generateBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Generate recovery plan clicked');
                    generateRecoveryPlan();
                });
            }
        }, 1000);
        
        console.log('Clinic Financial Resilience Platform loaded successfully');
    </script>
</body>
</html>