<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Cyber Resilience Simulator</title>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Hospital Cyber Resilience Simulator Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Color Palette */
            --primary-blue: #2563EB;
            --primary-green: #10B981;
            --danger-red: #EF4444;
            --warning-yellow: #F59E0B;
            --neutral-gray: #6B7280;
            --light-gray: #F3F4F6;
            --white: #FFFFFF;
            --dark: #1F2937;
            
            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            
            /* Spacing */
            --container-max: 1400px;
            --section-padding: 2rem;
            --card-padding: 1.5rem;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--light-gray);
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: var(--container-max);
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        .header {
            background: var(--white);
            border-bottom: 2px solid var(--light-gray);
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand h1 {
            color: var(--primary-blue);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--neutral-gray);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary-green);
        }

        /* Main Content */
        .main-content {
            padding: var(--section-padding) 0;
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: 12px;
            padding: var(--card-padding);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }

        .card h2 {
            color: var(--dark);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .card h3 {
            color: var(--dark);
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* Hospital Selection */
        .hospital-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .hospital-card {
            background: var(--white);
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .hospital-card:hover {
            border-color: var(--primary-blue);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(37, 99, 235, 0.1);
        }

        .hospital-card.selected {
            border-color: var(--primary-blue);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(16, 185, 129, 0.05));
        }

        .hospital-card h3 {
            color: var(--dark);
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .hospital-card p {
            color: var(--neutral-gray);
            margin-bottom: 1rem;
        }

        .hospital-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .hospital-stats .stat {
            background: var(--light-gray);
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .stat-label {
            display: block;
            font-weight: 500;
            color: var(--neutral-gray);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            display: block;
            font-weight: 700;
            color: var(--dark);
            font-size: 1rem;
            margin-top: 0.25rem;
        }

        /* Input Groups */
        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .input-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .input-group small {
            display: block;
            color: var(--neutral-gray);
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        /* Buttons */
        .btn-primary {
            background: var(--primary-blue);
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #1D4ED8;
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: var(--neutral-gray);
            cursor: not-allowed;
            transform: none;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary-blue);
            text-align: center;
        }

        .metric-card.danger {
            border-left-color: var(--danger-red);
        }

        .metric-card.warning {
            border-left-color: var(--warning-yellow);
        }

        .metric-card.success {
            border-left-color: var(--primary-green);
        }

        .metric-card h3 {
            color: var(--neutral-gray);
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .metric-change {
            font-size: 0.875rem;
            color: var(--neutral-gray);
        }

        .metric-change.negative {
            color: var(--danger-red);
        }

        .metric-change.positive {
            color: var(--primary-green);
        }

        /* Chart Section */
        .chart-section {
            margin: 2rem 0;
        }

        .chart-container {
            position: relative;
            height: 400px;
            background: var(--white);
            border-radius: 12px;
            padding: 1rem;
        }

        /* AI Recommendations */
        .recommendations-section {
            margin-top: 2rem;
        }

        .recommendation-card {
            background: var(--white);
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-blue);
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .priority-badge {
            background: var(--primary-blue);
            color: var(--white);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-badge.high {
            background: var(--danger-red);
        }

        .priority-badge.medium {
            background: var(--warning-yellow);
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--neutral-gray);
            font-style: italic;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--light-gray);
            border-top: 2px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hidden elements */
        .hidden {
            display: none;
        }

        /* API Key Warning */
        .api-warning {
            background: #FFF3CD;
            border: 1px solid #FFEAA7;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .api-warning h4 {
            margin-bottom: 0.5rem;
        }

        .api-warning code {
            background: #F8F9FA;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .header .container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .hospital-options {
                grid-template-columns: 1fr;
            }
            
            .hospital-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="nav-brand">
                <h1>🏥 Hospital Cyber Resilience Simulator</h1>
            </div>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span id="ai-status">AI Ready</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            
            <!-- API Key Setup Warning -->
            <div class="api-warning" id="api-warning">
                <h4>⚠️ OpenAI API Key Required</h4>
                <p>To use AI recommendations, please configure your OpenAI API key:</p>
                <ol>
                    <li>Get an API key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI</a></li>
                    <li>Copy <code>.env.example</code> to <code>.env</code></li>
                    <li>Add your API key to the <code>.env</code> file</li>
                    <li>Or edit the CONFIG object in this HTML file directly</li>
                </ol>
                <p><small>Mock recommendations will be used if no API key is configured.</small></p>
            </div>
            
            <!-- Step 1: Hospital Selection -->
            <section class="card">
                <h2>Step 1: Select Your Hospital Profile</h2>
                <p>Choose the hospital profile that best matches your organization:</p>
                
                <div class="hospital-options">
                    <div class="hospital-card" data-hospital="rural" onclick="selectHospital('rural')">
                        <h3>Rural General Hospital</h3>
                        <p>Small to medium-sized community hospital serving rural populations</p>
                        <div class="hospital-stats">
                            <div class="stat">
                                <span class="stat-label">Beds</span>
                                <span class="stat-value">150</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Annual Revenue</span>
                                <span class="stat-value">$61M</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Daily Costs</span>
                                <span class="stat-value">$190K</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Cyber Readiness</span>
                                <span class="stat-value">26/100</span>
                            </div>
                        </div>
                    </div>

                    <div class="hospital-card" data-hospital="urban" onclick="selectHospital('urban')">
                        <h3>Urban Medical Center</h3>
                        <p>Large metropolitan hospital with specialized services and research</p>
                        <div class="hospital-stats">
                            <div class="stat">
                                <span class="stat-label">Beds</span>
                                <span class="stat-value">400</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Annual Revenue</span>
                                <span class="stat-value">$230M</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Daily Costs</span>
                                <span class="stat-value">$656K</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Cyber Readiness</span>
                                <span class="stat-value">42/100</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Step 2: Attack Configuration -->
            <section class="card hidden" id="attack-config">
                <h2>Step 2: Configure Cyberattack Scenario</h2>
                <p>Specify the financial impact of the cyberattack on your hospital:</p>
                
                <div class="input-group">
                    <label for="attack-loss">Total Financial Loss</label>
                    <input type="number" id="attack-loss" value="7000000" min="100000" step="100000">
                    <small>Default: $7M (average cyberattack cost based on healthcare industry data)</small>
                </div>

                <div class="input-group">
                    <label for="recovery-weeks">Target Recovery Timeline</label>
                    <input type="number" id="recovery-weeks" value="6" min="2" max="12">
                    <small>Weeks to return to normal operations (typical: 4-8 weeks)</small>
                </div>

                <button class="btn-primary" onclick="runSimulation()">Run Financial Impact Simulation</button>
            </section>

            <!-- Step 3: Impact Analysis -->
            <section class="card hidden" id="impact-analysis">
                <h2>Step 3: Cyberattack Financial Impact</h2>
                <p>Immediate financial impact assessment for your hospital:</p>
                
                <div class="metrics-grid" id="impact-metrics">
                    <!-- Metrics will be populated by JavaScript -->
                </div>
            </section>

            <!-- Step 4: Recovery Timeline -->
            <section class="card hidden" id="recovery-timeline">
                <h2>Step 4: 6-Week Recovery Simulation</h2>
                <p>Financial recovery timeline and cash flow projections:</p>
                
                <div class="chart-section">
                    <div class="chart-container">
                        <canvas id="recovery-chart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Step 5: AI Recommendations -->
            <section class="card hidden" id="ai-recommendations">
                <h2>Step 5: AI-Powered Recovery Recommendations</h2>
                <p>Personalized recovery strategies based on your hospital profile and attack severity:</p>
                
                <button class="btn-primary" onclick="generateAIRecommendations()" id="ai-btn">
                    Generate AI Recommendations
                </button>
                
                <div id="recommendations-container" class="recommendations-section">
                    <!-- AI recommendations will be populated here -->
                </div>
            </section>

        </div>
    </main>

    <script>
        // Configuration - Replace with your actual API key
        // To set up locally: 
        // 1. Create a .env file with: OPENAI_API_KEY=your_actual_api_key
        // 2. For local development, you can replace 'YOUR_OPENAI_API_KEY_HERE' with your actual key
        const CONFIG = {
            OPENAI_API_KEY: 'YOUR_OPENAI_API_KEY_HERE' // Replace with your actual OpenAI API key
        };
        
        // Global state
        let currentHospital = null;
        let currentSimulation = null;
        let recoveryChart = null;

        // Hospital Data Models (embedded)
        const hospitalData = {
            rural: {
                id: 'rural',
                name: 'Rural General Hospital',
                type: 'Rural Community Hospital',
                beds: 150,
                annualRevenue: 61000000,
                dailyOperatingCosts: 190500,
                liquidAssets: 10500000,
                operatingDays: 55,
                cyberReadiness: 26,
                departments: {
                    emergency: { dailyCost: 45000, vulnerability: 'high', criticality: 'critical' },
                    icu: { dailyCost: 38000, vulnerability: 'high', criticality: 'critical' },
                    surgery: { dailyCost: 32000, vulnerability: 'medium', criticality: 'high' },
                    radiology: { dailyCost: 18000, vulnerability: 'high', criticality: 'high' },
                    pharmacy: { dailyCost: 15000, vulnerability: 'medium', criticality: 'high' },
                    lab: { dailyCost: 12000, vulnerability: 'medium', criticality: 'medium' },
                    administration: { dailyCost: 8500, vulnerability: 'critical', criticality: 'medium' },
                    hr: { dailyCost: 6000, vulnerability: 'medium', criticality: 'low' },
                    maintenance: { dailyCost: 7000, vulnerability: 'low', criticality: 'medium' },
                    security: { dailyCost: 4000, vulnerability: 'high', criticality: 'high' },
                    it: { dailyCost: 5000, vulnerability: 'critical', criticality: 'critical' }
                },
                revenueStreams: {
                    patientCare: 45000000,
                    emergency: 8000000,
                    outpatient: 5000000,
                    insurance: 3000000
                }
            },
            urban: {
                id: 'urban',
                name: 'Urban Medical Center',
                type: 'Large Metropolitan Hospital',
                beds: 400,
                annualRevenue: 230000000,
                dailyOperatingCosts: 656000,
                liquidAssets: 65000000,
                operatingDays: 99,
                cyberReadiness: 42,
                departments: {
                    emergency: { dailyCost: 125000, vulnerability: 'medium', criticality: 'critical' },
                    icu: { dailyCost: 98000, vulnerability: 'medium', criticality: 'critical' },
                    surgery: { dailyCost: 145000, vulnerability: 'medium', criticality: 'critical' },
                    radiology: { dailyCost: 65000, vulnerability: 'medium', criticality: 'high' },
                    pharmacy: { dailyCost: 45000, vulnerability: 'low', criticality: 'high' },
                    lab: { dailyCost: 38000, vulnerability: 'low', criticality: 'high' },
                    administration: { dailyCost: 35000, vulnerability: 'high', criticality: 'medium' },
                    hr: { dailyCost: 25000, vulnerability: 'medium', criticality: 'low' },
                    maintenance: { dailyCost: 28000, vulnerability: 'low', criticality: 'medium' },
                    security: { dailyCost: 18000, vulnerability: 'medium', criticality: 'high' },
                    it: { dailyCost: 34000, vulnerability: 'high', criticality: 'critical' }
                },
                revenueStreams: {
                    patientCare: 180000000,
                    emergency: 25000000,
                    outpatient: 15000000,
                    research: 5000000,
                    teaching: 5000000
                }
            }
        };

        // Initialize app
        window.addEventListener('DOMContentLoaded', function() {
            checkAPIKeyStatus();
        });

        // Check API Key Status
        function checkAPIKeyStatus() {
            const hasAPIKey = CONFIG.OPENAI_API_KEY && CONFIG.OPENAI_API_KEY !== 'YOUR_OPENAI_API_KEY_HERE';
            const statusElement = document.getElementById('ai-status');
            const warningElement = document.getElementById('api-warning');
            
            if (hasAPIKey) {
                statusElement.textContent = 'AI Ready';
                warningElement.style.display = 'none';
            } else {
                statusElement.textContent = 'Mock Mode';
                warningElement.style.display = 'block';
            }
        }

        // Hospital Selection
        function selectHospital(hospitalId) {
            // Remove previous selections
            document.querySelectorAll('.hospital-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            document.querySelector(`[data-hospital="${hospitalId}"]`).classList.add('selected');
            
            // Update global state
            currentHospital = hospitalData[hospitalId];
            
            // Show attack configuration
            document.getElementById('attack-config').classList.remove('hidden');
            
            console.log('Selected hospital:', currentHospital);
        }

        // Run Simulation
        function runSimulation() {
            if (!currentHospital) return;
            
            const attackLoss = parseInt(document.getElementById('attack-loss').value);
            const recoveryWeeks = parseInt(document.getElementById('recovery-weeks').value);
            
            // Calculate impact
            const impact = calculateAttackImpact(currentHospital, attackLoss);
            const timeline = generateRecoveryTimeline(currentHospital, impact, recoveryWeeks);
            
            currentSimulation = { impact, timeline, attackLoss, recoveryWeeks };
            
            // Show results
            displayImpactAnalysis(impact);
            displayRecoveryTimeline(timeline);
            
            // Show sections
            document.getElementById('impact-analysis').classList.remove('hidden');
            document.getElementById('recovery-timeline').classList.remove('hidden');
            document.getElementById('ai-recommendations').classList.remove('hidden');
            
            console.log('Simulation results:', currentSimulation);
        }

        // Calculate Attack Impact
        function calculateAttackImpact(hospital, attackLoss) {
            const dailyRevenue = hospital.annualRevenue / 365;
            const systemDowntimeDays = Math.ceil(attackLoss / (dailyRevenue * 0.8)); // Estimate downtime
            
            return {
                totalLoss: attackLoss,
                systemDowntimeDays: Math.min(systemDowntimeDays, 14), // Max 2 weeks
                lostRevenue: dailyRevenue * systemDowntimeDays,
                emergencyExpenses: attackLoss * 0.3, // Recovery costs
                cashFlowImpact: attackLoss + (hospital.dailyOperatingCosts * systemDowntimeDays),
                operatingDaysRemaining: Math.max(0, hospital.operatingDays - Math.ceil(attackLoss / hospital.dailyOperatingCosts)),
                departmentImpacts: calculateDepartmentImpacts(hospital.departments, attackLoss)
            };
        }

        // Calculate Department Impacts
        function calculateDepartmentImpacts(departments, attackLoss) {
            const impacts = {};
            const totalDailyCost = Object.values(departments).reduce((sum, dept) => sum + dept.dailyCost, 0);
            
            Object.entries(departments).forEach(([name, dept]) => {
                const impactMultiplier = getVulnerabilityMultiplier(dept.vulnerability);
                const deptImpact = (dept.dailyCost / totalDailyCost) * attackLoss * impactMultiplier;
                
                impacts[name] = {
                    ...dept,
                    financialImpact: deptImpact,
                    operationalImpact: getCriticalityImpact(dept.criticality),
                    recoveryPriority: getRecoveryPriority(dept.criticality, dept.vulnerability)
                };
            });
            
            return impacts;
        }

        // Helper functions for impact calculation
        function getVulnerabilityMultiplier(vulnerability) {
            const multipliers = { 'low': 0.5, 'medium': 1.0, 'high': 1.5, 'critical': 2.0 };
            return multipliers[vulnerability] || 1.0;
        }

        function getCriticalityImpact(criticality) {
            const impacts = { 'low': 'Minimal', 'medium': 'Moderate', 'high': 'Severe', 'critical': 'Critical' };
            return impacts[criticality] || 'Moderate';
        }

        function getRecoveryPriority(criticality, vulnerability) {
            if (criticality === 'critical') return 1;
            if (criticality === 'high' && vulnerability === 'critical') return 2;
            if (criticality === 'high') return 3;
            return 4;
        }

        // Generate Recovery Timeline
        function generateRecoveryTimeline(hospital, impact, recoveryWeeks) {
            const timeline = [];
            const weeklyRecovery = impact.totalLoss / recoveryWeeks;
            
            for (let week = 1; week <= recoveryWeeks; week++) {
                const recoveryPercentage = (week / recoveryWeeks) * 100;
                const remainingLoss = impact.totalLoss - (weeklyRecovery * week);
                const operationalCapacity = Math.min(recoveryPercentage, 100);
                
                timeline.push({
                    week: week,
                    recoveryPercentage: Math.round(recoveryPercentage),
                    remainingLoss: Math.max(0, remainingLoss),
                    operationalCapacity: Math.round(operationalCapacity),
                    cashFlow: hospital.dailyOperatingCosts * 7 * (operationalCapacity / 100),
                    phase: getRecoveryPhase(week, recoveryWeeks)
                });
            }
            
            return timeline;
        }

        function getRecoveryPhase(week, totalWeeks) {
            const progress = week / totalWeeks;
            if (progress <= 0.33) return 'Crisis Management';
            if (progress <= 0.66) return 'System Recovery';
            return 'Full Operations';
        }

        // Display Impact Analysis
        function displayImpactAnalysis(impact) {
            const container = document.getElementById('impact-metrics');
            
            const metrics = [
                {
                    title: 'Total Financial Loss',
                    value: `$${(impact.totalLoss / 1000000).toFixed(1)}M`,
                    change: 'Initial cyberattack cost',
                    type: 'danger'
                },
                {
                    title: 'System Downtime',
                    value: `${impact.systemDowntimeDays} days`,
                    change: 'Estimated recovery time',
                    type: 'warning'
                },
                {
                    title: 'Lost Revenue',
                    value: `$${(impact.lostRevenue / 1000000).toFixed(1)}M`,
                    change: 'Revenue during downtime',
                    type: 'danger'
                },
                {
                    title: 'Operating Days Left',
                    value: `${impact.operatingDaysRemaining} days`,
                    change: 'Without additional funding',
                    type: impact.operatingDaysRemaining < 30 ? 'danger' : 'warning'
                }
            ];
            
            container.innerHTML = metrics.map(metric => `
                <div class="metric-card ${metric.type}">
                    <h3>${metric.title}</h3>
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-change">${metric.change}</div>
                </div>
            `).join('');
        }

        // Display Recovery Timeline
        function displayRecoveryTimeline(timeline) {
            const ctx = document.getElementById('recovery-chart').getContext('2d');
            
            if (recoveryChart) {
                recoveryChart.destroy();
            }
            
            recoveryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeline.map(t => `Week ${t.week}`),
                    datasets: [
                        {
                            label: 'Recovery Progress (%)',
                            data: timeline.map(t => t.recoveryPercentage),
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Operational Capacity (%)',
                            data: timeline.map(t => t.operationalCapacity),
                            borderColor: '#2563EB',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Percentage'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Hospital Recovery Timeline'
                        }
                    }
                }
            });
        }

        // Generate AI Recommendations
        async function generateAIRecommendations() {
            if (!currentHospital || !currentSimulation) return;
            
            const button = document.getElementById('ai-btn');
            const container = document.getElementById('recommendations-container');
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<div class="spinner"></div> Generating AI Recommendations...';
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Analyzing hospital profile and generating personalized recommendations...</div>';
            
            try {
                const recommendations = await callOpenAI();
                displayRecommendations(recommendations);
            } catch (error) {
                console.error('OpenAI API Error:', error);
                // Fallback to mock recommendations
                displayRecommendations(getMockRecommendations());
            }
            
            // Reset button
            button.disabled = false;
            button.innerHTML = 'Regenerate Recommendations';
        }

        // OpenAI API Call
        async function callOpenAI() {
            // Check if API key is configured
            if (!CONFIG.OPENAI_API_KEY || CONFIG.OPENAI_API_KEY === 'YOUR_OPENAI_API_KEY_HERE') {
                console.warn('OpenAI API key not configured. Using mock recommendations.');
                throw new Error('API key not configured');
            }

            const prompt = `You are a hospital financial recovery expert. Based on this hospital profile and cyberattack scenario, provide 3-4 specific, actionable recovery recommendations.

Hospital Profile:
- Name: ${currentHospital.name}
- Type: ${currentHospital.type}
- Beds: ${currentHospital.beds}
- Annual Revenue: $${(currentHospital.annualRevenue / 1000000).toFixed(1)}M
- Daily Operating Costs: $${(currentHospital.dailyOperatingCosts / 1000).toFixed(0)}K
- Cyber Readiness Score: ${currentHospital.cyberReadiness}/100

Attack Impact:
- Total Loss: $${(currentSimulation.attackLoss / 1000000).toFixed(1)}M
- Recovery Timeline: ${currentSimulation.recoveryWeeks} weeks
- Operating Days Remaining: ${currentSimulation.impact.operatingDaysRemaining} days

Please provide recommendations in this exact JSON format:
{
  "recommendations": [
    {
      "title": "Specific actionable title",
      "priority": "high|medium|low",
      "description": "Detailed description",
      "impact": "Expected financial/operational impact",
      "timeframe": "Implementation timeframe"
    }
  ]
}`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 800,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`OpenAI API error: ${response.status}`);
            }

            const data = await response.json();
            const content = data.choices[0].message.content.trim();
            
            try {
                return JSON.parse(content);
            } catch (parseError) {
                console.error('Failed to parse OpenAI response:', content);
                throw parseError;
            }
        }

        // Mock AI Recommendations (fallback)
        function getMockRecommendations() {
            const hospitalType = currentHospital.id;
            
            if (hospitalType === 'rural') {
                return {
                    recommendations: [
                        {
                            title: "Prioritize Critical Care Systems",
                            priority: "high",
                            description: "Focus immediate recovery efforts on Emergency Department and ICU systems. These generate 65% of revenue and are essential for patient safety.",
                            impact: "Restore $45K daily revenue within 3-5 days",
                            timeframe: "Days 1-5 of recovery"
                        },
                        {
                            title: "Establish Emergency Credit Line",
                            priority: "high",
                            description: "Secure a $2-3M emergency credit facility to maintain operations during recovery. Rural hospitals qualify for special disaster lending rates.",
                            impact: "Extends operating runway by 15-20 days",
                            timeframe: "Immediate (1-2 days)"
                        },
                        {
                            title: "Implement Temporary Manual Systems",
                            priority: "medium",
                            description: "Deploy paper-based workflows for pharmacy and lab operations to maintain 60-70% capacity while IT systems recover.",
                            impact: "Maintain $12K daily departmental revenue",
                            timeframe: "Days 2-14 of recovery"
                        },
                        {
                            title: "Build Cybersecurity Emergency Fund",
                            priority: "medium",
                            description: "Establish a $1.5M cybersecurity emergency fund (2.5% of annual revenue) to prepare for future incidents.",
                            impact: "Reduces future recovery time by 40-50%",
                            timeframe: "6-12 months post-recovery"
                        }
                    ]
                };
            } else {
                return {
                    recommendations: [
                        {
                            title: "Activate Business Continuity Plan",
                            priority: "high",
                            description: "Deploy pre-configured backup systems for Surgery and ICU departments. Large hospitals should maintain 80% operational capacity during recovery.",
                            impact: "Maintains $180K daily critical care revenue",
                            timeframe: "Days 1-3 of recovery"
                        },
                        {
                            title: "Optimize Resource Allocation",
                            priority: "high",
                            description: "Temporarily consolidate non-critical services and reallocate staff to revenue-generating departments during system recovery.",
                            impact: "Reduces operating costs by $50K/day",
                            timeframe: "Week 1-2 of recovery"
                        },
                        {
                            title: "Leverage Teaching Hospital Benefits",
                            priority: "medium",
                            description: "Utilize research partnerships and academic affiliations to access emergency IT support and temporary equipment loans.",
                            impact: "Reduces recovery costs by $200-300K",
                            timeframe: "Days 3-10 of recovery"
                        },
                        {
                            title: "Establish Multi-Million Emergency Fund",
                            priority: "medium",
                            description: "Create a $5-7M cybersecurity emergency fund (3% of revenue) with quarterly contributions and investment growth strategy.",
                            impact: "Ensures financial resilience for major incidents",
                            timeframe: "12-18 months implementation"
                        }
                    ]
                };
            }
        }

        // Display Recommendations
        function displayRecommendations(data) {
            const container = document.getElementById('recommendations-container');
            
            if (!data || !data.recommendations) {
                container.innerHTML = '<div class="recommendation-card"><p>Unable to generate recommendations. Please try again.</p></div>';
                return;
            }
            
            container.innerHTML = data.recommendations.map(rec => `
                <div class="recommendation-card">
                    <div class="recommendation-header">
                        <h4>${rec.title}</h4>
                        <span class="priority-badge ${rec.priority}">${rec.priority.toUpperCase()}</span>
                    </div>
                    <p><strong>Description:</strong> ${rec.description}</p>
                    <p><strong>Expected Impact:</strong> ${rec.impact}</p>
                    <p><strong>Timeframe:</strong> ${rec.timeframe}</p>
                </div>
            `).join('');
        }

        // Utility function to format currency
        function formatCurrency(amount) {
            if (amount >= 1000000) {
                return `$${(amount / 1000000).toFixed(1)}M`;
            } else if (amount >= 1000) {
                return `$${(amount / 1000).toFixed(0)}K`;
            } else {
                return `$${amount.toLocaleString()}`;
            }
        }

        // Initialize application
        console.log('Hospital Cyber Resilience Simulator loaded successfully');
        console.log('Available hospitals:', Object.keys(hospitalData));
    </script>
</body>
</html>